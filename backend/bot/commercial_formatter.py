"""
Commercial Telegram Formatter
Separate message formats for FREE and VIP channels
"""
import re

def escape_md(text: str) -> str:
    """Escape special characters for Telegram Markdown v2"""
    return re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', str(text))


def format_free_message(payload: dict) -> str:
    """
    Format signal for FREE channel (Marketing-focused).
    
    Features:
    - Simplified information
    - No TP/SL details
    - Delayed signal notice
    - VIP upgrade CTA
    
    Args:
        payload: Signal data
        
    Returns:
        str: Formatted FREE message
    """
    asset = payload.get("symbol") or payload.get("asset", "EUR/USD")
    direction = payload.get("direction", "BUY")
    entry = payload.get("entry", 0)
    confidence = payload.get("confidence", 0)
    
    # Handle entry as array or single value
    if isinstance(entry, list):
        entry_text = f"{entry[0]}"
    else:
        entry_text = str(entry)
    
    dir_emoji = "ðŸŸ¢" if direction == "BUY" else "ðŸ”´"
    
    return f"""ðŸ”¥ *HIGH CONFIDENCE SIGNAL*

ðŸ“Š *{escape_md(asset)}*
{dir_emoji} Action: {direction}
ðŸŽ¯ Entry: {entry_text}
â­ Confidence: {confidence}%

â³ _Delayed Signal_
ðŸ“ˆ _For educational purposes only_

ðŸ‘‰ Join VIP for real\\-time \\& full analysis

âš ï¸ _This signal is generated by an AI\\-assisted system\\._
_Not financial advice\\. Trade at your own risk\\._""".strip()


def format_vip_message(payload: dict) -> str:
    """
    Format signal for VIP channel (Trader-grade).
    
    Features:
    - Full trading details
    - TP/SL levels
    - Strategy explanation
    - Risk assessment
    - Professional disclaimer
    
    Args:
        payload: Signal data
        
    Returns:
        str: Formatted VIP message
    """
    asset = payload.get("symbol") or payload.get("asset", "EUR/USD")
    direction = payload.get("direction", "BUY")
    entry = payload.get("entry", 0)
    tp = payload.get("tp", 0)
    sl = payload.get("sl", 0)
    confidence = payload.get("confidence", 0)
    timeframe = payload.get("timeframe", "M15")
    strategy = payload.get("strategy", "Rule Engine")
    
    # Handle entry as array or single value
    if isinstance(entry, list):
        entry_text = f"{entry[0]} â€“ {entry[1]}"
    else:
        entry_text = str(entry)
    
    # Risk assessment
    if confidence >= 90:
        risk = "Low"
    elif confidence >= 80:
        risk = "Medium"
    else:
        risk = "Medium\\-High"
    
    dir_emoji = "ðŸŸ¢" if direction == "BUY" else "ðŸ”´"
    
    return f"""ðŸš¨ *TRADE SIGNAL â€“ HIGH CONFIDENCE*

ðŸ“Š *{escape_md(asset)}*
{dir_emoji} Action: {direction}
ðŸŽ¯ Entry: {entry_text}
ðŸŽ¯ TP: {tp}
ðŸ›‘ SL: {sl}

â­ Confidence: {confidence}% \\(HIGH\\)
ðŸ§  Strategy: {escape_md(strategy)}
â° Timeframe: {timeframe}

âš ï¸ Risk: {risk}
ðŸ“Œ Manage position size carefully

âš ï¸ _This signal is generated by an AI\\-assisted system\\._
_Not financial advice\\. Trade at your own risk\\._""".strip()


def format_message_by_tier(payload: dict, channel_type: str = "vip") -> str:
    """
    Route to appropriate formatter based on channel type.
    
    Args:
        payload: Signal data
        channel_type: "free" or "vip"
        
    Returns:
        str: Formatted message
    """
    if channel_type.lower() == "free":
        return format_free_message(payload)
    else:
        return format_vip_message(payload)
